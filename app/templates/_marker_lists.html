<!--Categorical lists for specified and regulated markers in edit.html represent encoded values. #}
The WTForm for edit.html provides list values in formats
 - SAB:code (description) for specified markers
 - SAB:code (description)<tab> type of regulation for regulating markers

Build lists with:
- A hidden list element with value=SAB:code|(type of regulation). The Update button will POST the hidden list values.
- A span with the full display term.
- Add and remove buttons allow addition or removal of individual items (via JavaScript)
- A bulk add button that loads values from CSV (via JavaScript)
-->
{% macro render_marker_section(form, field_name, single_modal_id, csv_modal_id, label_bg="#F0FDF4") %}
<div class="col-md-6" style="background-color: {{ label_bg }}; border: 1px solid #ccc; border-radius: 5px; padding: 16px;">
    <strong>{{ form[field_name].label }}</strong>
    <ul id="{{ field_name }}-list" class="list-group mb-2 w-100">

        {% for field in form[field_name] %}
            {% set field_full = field.data %}

            {# Split the marker (description) from the type of regulation. #}
            {% set parts = field_full.split('|') %}
            {% set marker_and_description = parts[0] if parts|length > 1 else field_full %}

            {# Extract marker #}
            {% if '(' in marker_and_description and ')' in marker_and_description %}
                {% set paren_start = marker_and_description.find('(') %}
                {% set paren_end = marker_and_description.find(')') %}
                {% set marker = marker_and_description[:paren_start].strip() %}
                {% set description = marker_and_description[paren_start + 1:paren_end] %}
              {% else %}
                {% set marker=marker_and_description %}
            {% endif %}

            {# Translate regulation type to symbol #}
            {% set regulation_type = parts[1].strip() if parts|length > 1 else "" %}
            {% set field_hidden_code = marker %}
            {% set field_hidden_action = regulation_type %}

            {% if field_name == "regmarker" %}
                {% if regulation_type == "up_regulates" %}
                    {% set regulation_symbol = "↑" %}
                {% elif regulation_type == "down_regulates" %}
                    {% set regulation_symbol = "↓" %}
                {% elif regulation_type == "inconclusively_regulates" %}
                    {% set regulation_symbol = "?" %}
                {% else %}
                    {% set regulation_symbol = "" %}
                {% endif %}
                {% set display_string = marker_and_description ~ " " ~ regulation_symbol %}
            {% else %}
                {% set display_string = marker_and_description if marker_and_description else field_full %}
            {% endif %}

        <li class="list-group-item d-flex justify-content-between align-items-center">
            <!-- Hidden input with code only -->
                <!--<input type="hidden" name="{{ field.name }}" value="{{ field_hidden }}">-->
                <input name="{{ field.code }}" value="{{ field_hidden_code }}">
                {% if regulation_type %}
                    <input name="{{ field.action}}" value="{{ field_hidden_action }}">
                {% endif %}
                <!-- Display full string -->
                <span class="list-field-display" name="{{ field_name }}_field_display">{{ display_string }}</span>
                <button type="button" class="btn btn-sm btn-danger ms-2" onclick="removeMarker(this)">-</button>
            </li>

        {% endfor %}
        {% for error in form[field_name].errors %}
            <div class="text-danger">{{ error }}</div>
        {% endfor %}

    </ul>
    <button type="button"
            title="Add single specified {{ field_name }}"
            aria-label="Add single specified {{ field_name }}"
            class="btn btn-outline-primary btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#{{ single_modal_id }}">
        +
    </button>
    <!-- Add CSV upload button below list -->
    <button type="button"
            title="Add multiple specified {{ field_name }}s"
            aria-label="Add multiple specified {{ field_name }}s"
            class="btn btn-outline-primary btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#{{ csv_modal_id }}">
        Add {{ field_name|capitalize }}s from CSV
    </button>
</div>
{% endmacro %}