<!--
Categorical lists of assertions in edit.html (excluding
specified marker and regulating marker lists) represent encoded values.

The WTForm for edit.html provides list values in format
SAB:code (description)

Build sections with lists for which each row contains:
- A hidden list element with value=SAB:code.
  The Update button will POST the hidden list values.
- A span with value=
  - description for simple assertions
  - SAB:code (description) for "external" assertions--i.e., those that require calls to
    external APIs to obtain terms
  The span corresponds to the display value of the list element.
- Add and remove buttons that modify the lists (via Javascript).

Arguments:
- form - the Edit form
- field_name - the name of the field input
- modal_id - the id in edit.html of the modal div used to add new values of field_name
             to the associated list
- label_bg - label background hex code
- is_external - whether the field's term has to be obtained via call to external api
- col_class - Bootstrap column class to use
-->

{% macro render_fieldlist_section(form, field_name, modal_id, label_bg="#FEF2F2", is_external=False, col_class="col-md-4", groups_token=None) %}
<div class="{{ col_class }}" style="background-color: {{ label_bg }}; border: 1px solid #ccc; border-radius: 5px; padding: 3px;">
    {# header #}
    <strong style="margin-left: 12px;">{{ form[field_name].label }}</strong>
    <div class="d-flex align-items-start">
        <ul id="{{ field_name }}-list" class="list-group mb-2 w-100" style="margin-bottom:0!important; margin-left: 12px;">
            <!-- Parse code from value provided by WTForms field. -->
            {% for field in form[field_name] %}
                {% set full_value = field.data %}
                {% if is_external %}
                    {% set display_value = full_value %}
                {% else %}
                    {% set display_value = full_value.split('(')[1][0:-1] if '(' in full_value else full_value %}
                {% endif %}
                {% set hidden_value = (full_value or '').split(' ')[0] %}

                <li class="list-group-item d-flex justify-content-between align-items-center w-100">
                    <!-- Hidden input used to store value for post -->
                    <input name="{{ field.name }}" type="hidden" value="{{ hidden_value }}">
                    <!-- Span for value displayed in list -->
                    <span class="list-field-display" style="padding-left:3px; padding-right:3px;" name="{{ field_name }}_field_display">{{ display_value }}</span>
                    <!-- For fields with external links, create a placeholder for the link button created via Javascript. -->
                    {% if field_name == "dataset" %}
                        <!-- Placeholder for the dataset link button, id is unique per hidden_value -->
                        <span class="dataset-link-placeholder ms-2" id="dataset-link-{{ hidden_value | e }}"></span>
                    {% endif %}
                    {% if field_name == "citation" %}
                        <!-- Placeholder for the citation link button, id is unique per hidden_value -->
                        <span class="citation-link-placeholder ms-2" id="citation-link-{{ hidden_value | e }}"></span>
                    {% endif %}
                    {% if field_name == "origin" %}
                        <!-- Placeholder for the origin link button, id is unique per hidden_value -->
                        <span class="origin-link-placeholder ms-2" id="origin-link-{{ hidden_value | e }}"></span>
                    {% endif %}
                    <!-- Button to remove this value from the list -->
                    <button type="button" class="btn btn-sm btn-danger ms-2" style="width: 2.5em;" onclick="removeValue(this)"> - </button>

                </li>
            {% endfor %}
            <!-- Validation errors -->
            {% for error in form[field_name].errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
        </ul>
        <!-- Button to add values to the list -->
        <button type="button"
                title="Add {{ field_name }}"
                aria-label="Add {{ field_name }}"
                class="btn btn-sm ms-2"
                style="background-color: #0d6efd; color: #fff; margin-top:8px; width:2.5em; margin-right:12px;"
                data-bs-toggle="modal"
                data-bs-target="#{{ modal_id }}">
            +
        </button>
    </div>
</div>
    <!-- Add external link button where appropriate. -->
    {% if field_name == "dataset" %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                addLinkButtons(
                    '/dataset/portal/',
                    '#dataset-list input[type="hidden"]',
                    'View dataset details',
                    '.dataset-link-placeholder'
                );
            });
        </script>
    {% elif field_name == "citation" %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                addLinkButtons(
                    'https://pubmed.ncbi.nlm.nih.gov/',
                    '#citation-list input[type="hidden"]',
                    'View citation details',
                    '.citation-link-placeholder',
                    true
                );
            });
        </script>
    {% elif field_name == "origin" %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                addLinkButtons(
                    'https://scicrunch.org/resolver/',
                    '#origin-list input[type="hidden"]',
                    'View origin details',
                    '.origin-link-placeholder'
                );
            });
        </script>
    {% endif %}
{% endmacro %}

<!--
Renders a textarea field, analogous to the field lists used for the categorical fields.
Use case: DOI field
-->
{% macro render_textarea_section(form, field_name, modal_id, label_bg="#f5f5f5", link_base_url=None, link_title=None, parse_code=False) %}
<div style="background-color: {{ label_bg }};">
    <div class="d-flex align-items-center" id="{{ field_name }}-row">
        <label for="{{ form[field_name].id }}" class="me-2 mb-0 label-wide label-left-margin">
            {% set hidden_value = (form[field_name].data or '').split(' ')[0] %}
            <input name="{{ form[field_name].name }}" type="hidden" id="{{ field_name }}-hidden-input" value="{{ hidden_value }}">
            <strong>{{ form[field_name].label.text }}</strong>
        </label>
        <div class="d-flex align-items-start w-100">
            {{ form[field_name](class_="form-control", style="width: 100%;", rows="1") }}
            {% for error in form[field_name].errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
            <span id="{{ field_name }}-link-placeholder" class="ms-2"></span>
        </div>
        <button type="button"
                title="Remove {{ field_name }}"
                aria-label="Remove {{ field_name }}"
                class="btn btn-sm btn-danger ms-2 align-self-start"
                style="margin-left: 8px; margin-top:8px; width: 2.5em;"
                onclick="clearAll{{ field_name | capitalize }}References()">
            -
        </button>
        <button type="button"
                title="Edit {{ field_name }}"
                aria-label="Edit {{ field_name }}"
                class="btn btn-sm ms-2 align-self-start"
                style="background-color: #0d6efd; color: #fff; margin-left: 8px; margin-top:8px; width: 2.5em;"
                data-bs-toggle="modal"
                data-bs-target="#{{ modal_id }}">
            +
        </button>
        <span class="{{ field_name }}-link-placeholder ms-2 align-self-start"
              id="{{ field_name }}-link-{{ hidden_value | e }}"
              style="margin-top:8px;"></span>
        {% if link_base_url %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var hiddenInput = document.getElementById('{{ field_name }}-hidden-input');
                if (hiddenInput && hiddenInput.value && hiddenInput.value.trim() !== "") {
                    addLinkButtons(
                        '{{ link_base_url }}',
                        '#{{ field_name }}-hidden-input',
                        '{{ link_title if link_title else "View details" }}',
                        '.{{ field_name }}-link-placeholder',
                        {{ "true" if parse_code else "false" }}
                    );
                }
            });
        </script>
        {% endif %}
    </div>
</div>
{% endmacro %}

