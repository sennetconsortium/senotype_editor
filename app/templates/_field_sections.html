<!--
Categorical lists of assertions in edit.html (excluding
specified marker and regulating marker lists) represent encoded values.

The WTForm for edit.html provides list values in format
SAB:code (description)

Build sections with lists for which each row contains:
- A hidden list element with value=SAB:code.
  The Update button will POST the hidden list values.
- A span with value=
  - description for simple assertions
  - SAB:code (description) for "external" assertions--i.e., those that require calls to
    external APIs to obtain terms
  The span corresponds to the display value of the list element.
- Add and remove buttons that modify the lists (via Javascript).

Arguments:
- form - the Edit form
- field_name - the name of the field input
- modal_id - the id in edit.html of the modal div used to add new values of field_name
             to the associated list
- label_bg - label background hex code
- is_external - whether the field's term has to be obtained via call to external api
- col_class - Bootstrap column class to use
-->

{% macro render_fieldlist_section(form, field_name, modal_id, label_bg="#FEF2F2", is_external=False, col_class="col-md-4", groups_token=None) %}
<div class="{{ col_class }}" style="background-color: {{ label_bg }}; border: 1px solid #ccc; border-radius: 5px; padding: 3px;">
    {# header #}
    <strong>{{ form[field_name].label }}</strong>
    <div class="d-flex align-items-start">
        <ul id="{{ field_name }}-list" class="list-group mb-2 w-100" style="margin-bottom:0!important;">
            <!-- Parse code from value provided by WTForms field. -->
            {% for field in form[field_name] %}
                {% set full_value = field.data %}
                {% if is_external %}
                    {% set display_value = full_value %}
                {% else %}
                    {% set display_value = full_value.split('(')[1][0:-1] if '(' in full_value else full_value %}
                {% endif %}
                {% set hidden_value = full_value.split(' ')[0] %}

                <li class="list-group-item d-flex justify-content-between align-items-center w-100">
                    <!-- Hidden input used to store value for post -->
                    <input name="{{ field.name }}" type="hidden" value="{{ hidden_value }}">
                    <!-- Span for value displayed in list -->
                    <span class="list-field-display" style="padding-left:3px; padding-right:3px;" name="{{ field_name }}_field_display">{{ display_value }}</span>
                    <!-- Button to remove this value from the list -->
                    <button type="button" class="btn btn-sm btn-danger ms-2" style="width: 2.5em;" onclick="removeValue(this)"> - </button>
                    {% if field_name == "dataset" %}
                    <!-- Placeholder for the dataset link button, id is unique per hidden_value -->
                    <span class="dataset-link-placeholder ms-2" id="dataset-link-{{ hidden_value | e }}"></span>
                    {% endif %}
                </li>
            {% endfor %}
            <!-- Validation errors -->
            {% for error in form[field_name].errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
        </ul>
        <!-- Button to add values to the list -->
        <button type="button"
                title="Add {{ field_name }}"
                aria-label="Add {{ field_name }}"
                class="btn btn-sm ms-2"
                style="background-color: #0d6efd; color: #fff; margin-top:8px; width: 2.5em;"
                data-bs-toggle="modal"
                data-bs-target="#{{ modal_id }}">
            +
        </button>
    </div>
</div>
    <!-- Add external link button where appropriate. -->
    {% if field_name == "dataset" %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                addLinkButtons(
                    '/dataset/portal/',
                    '#dataset-list input[type="hidden"]',
                    'View dataset details',
                    '.dataset-link-placeholder'
                );
            });
        </script>
    {% endif %}
{% endmacro %}

<!--
Renders the DOI textarea field, analogous to the field lists used for the categorical fields.
-->
{% macro render_textarea_section(form, field_name, modal_id, label_bg="#f5f5f5") %}
<div style="background-color: {{ label_bg }};">
    <div class="d-flex align-items-center">
        <label for="{{ form[field_name].id }}" class="me-2 mb-0" style="white-space: nowrap;">
            <!-- Parse the code from the value returned by the WTForms field. -->
            {% set hidden_value = form[field_name].data.split(' ')[0] %}
            <!-- Hidden input to store the DOI id for post. -->
            <input name="{{ form[field_name].name }}" type="hidden" value="{{ hidden_value }}">
            <strong>{{ form[field_name].label.text }}</strong>
        </label>
        <!-- Validation errors -->
        <div class="flex-grow-1 w-100">
            {{ form[field_name](class_="form-control", rows=2, style="resize: vertical; width: 100%;") }}
            {% for error in form[field_name].errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
        </div>
        <!-- Button to add a DOI -->
        <button type="button"
                title="Edit {{ field_name }}"
                aria-label="Edit {{ field_name }}"
                class="btn btn-sm ms-2"
                style="background-color: #0d6efd; color: #fff; margin-left: 8px; margin-top:8px; width: 2.5em;"
                data-bs-toggle="modal"
                data-bs-target="#{{ modal_id }}">
            +
        </button>
        <!-- Button to clear all DOIs -->
        <button type="button"
                title="Remove DOI"
                aria-label="Remove DOI"
                class="btn btn-sm btn-danger ms-2"
                style="margin-left: 8px; margin-top:8px; width: 2.5em;"
                onclick="clearAllDoiReferences()">
            -
        </button>
    </div>
</div>
{% endmacro %}

