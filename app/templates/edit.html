{% extends 'base.html' %}

{% block content %}
<!--Data for the senotype treeview passed from the edit route in Flask.-->
<script>
  window.tree_data = {{ response.tree_data|tojson|safe }};
</script>

<!-- JINJA RENDERING MACROS-->
<!-- Standard field rendering -->
{% from "_formhelpers.html" import render_field %}
<!-- Renders sections for assertions other than markers, with add button and error display-->
{% from "_field_sections.html" import render_fieldlist_section %}
{% from "_field_sections.html" import render_textarea_section %}
<!-- Renders sections for specified and regulating markers, with add buttons and error display -->
{% from "_marker_lists.html" import render_marker_section %}
{% from "_marker_lists.html" import render_regmarker_section %}
<!-- Renders "valueset select modals -- i.e., modals that allow selection from a valueset -->
{% from "_valueset_modal_macro.html" import valueset_modal %}
<!-- Renders "external search modals"--i.e., modals that call external APIs -->
{% from "_search_modal_macro.html" import search_modal %}

<!-- START OF PAGE -->
<!-- EDIT FORM -->
<form id="edit_form" method="post" action= "/edit" class="mt-0 m-3">
    <!-- Senotype / Submission -->
    <div class="row">
      <!-- Senotype column -->
        <div class="col-md-4 input-treeView">
          <div class="row">
            <div class="col-12">
              <div style="position: relative; width: 100%;">
                <!--Senotype treeview -->
                <div id="senotype-tree"
                    title="Expand the tree to navigate to a version of a Senotype">
                </div>

                <!-- Hidden input to track the selected node -->
                <input type="hidden" name="selected_node_id" id="selected_node_id" value="{{ selected_node_id or '' }}">

                <!-- Spinner and label below the treeview -->

                <div id="senotype-spinner"
                     class="spinner-border text-primary"
                     role="status"
                     style="display:none;top:10px;right:10px;z-index:10;width:2rem;height:2rem;">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <div id="senotype-spinner-label"
                     style="display:none;margin-top:10px;background-color:white; padding:3px;">
                  Loading...
                </div>

              </div>
            </div>
          </div>
          <!-- New version button -->
            <button type="button"
                class="btn mt-2"
                id="new-version-btn"
                disabled
                style="
                background-color:#144e14;
                color:#fff;" aria-label="Create new version of a Senotype"
                title="Create new version of a Senotype">
                new version
            </button>
        </div>
      <!-- Submission column -->
        <div class="col-md-8 mt-3">
            <h4 class="mb-3">Submitter</h4>
            <!-- Submitter fields -->
            <div class="row align-items-center mb-1">
                  <div class="col-md-4 d-flex align-items-center mb-2">
                    <label for="{{ form.submitterfirst.id }}" class="me-2 mb-0 label-wide label-left-margin"><strong>{{ form.submitterfirst.label.text }}</strong></label>
                    {{ form.submitterfirst(class="form-control d-inline-block", style="width: 100%;") }}
                  </div>
                  <div class="col-md-4 d-flex align-items-center mb-2">
                    <label for="{{ form.submitterlast.id }}" class="me-2 mb-0 label-wide label-left-margin"><strong>{{ form.submitterlast.label.text }}</strong></label>
                    {{ form.submitterlast(class="form-control d-inline-block", style="width: 100%;") }}
                  </div>
                  <div class="col-md-4 d-flex align-items-center">
                    <label for="{{ form.submitteremail.id }}" class="me-2 mb-0 label-wide label-left-margin"><strong>{{ form.submitteremail.label.text }}</strong></label>
                    {{ form.submitteremail(class="form-control d-inline-block", style="width: 100%;") }}
                  </div>
                </div>
            <!-- Submitter field errors -->
            <div class="row mb-1">
                  <div class="col-md-4">
                    {% for error in form.submitterfirst.errors %}
                      <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                  </div>
                  <div class="col-md-4">
                    {% for error in form.submitterlast.errors %}
                      <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                  </div>
                  <div class="col-md-4">
                    {% for error in form.submitteremail.errors %}
                      <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                  </div>
                </div>
            <h4>Submission</h4>
            <!-- Senotype id, name-->
            <div class="row align-items-center mb-2">
                <!-- ID -->
                <div class="col-md-4 d-flex align-items-center mb-2">
                    <label for="{{ form.senotypeid.id }}" class="me-2 mb-0 label-wide label-left-margin"><strong>{{ form.senotypeid.label.text }}</strong></label>
                    {{ form.senotypeid(class="form-control") }}
                </div>
                <!-- Name -->
                <div class="col-md-8 d-flex align-items-center">
                    <label for="{{ form.senotypename.id }}" class="me-2 mb-0 label-wide label-left-margin"><strong>{{ form.senotypename.label.text }}</strong></label>
                    {{ form.senotypename(class="form-control", style="width: 100%;", rows="1") }}
                </div>
            </div>
            <!-- Senotype id, name, description errors -->
            <div class="row mb-1">
                  <div class="col-md-4">
                    {% for error in form.senotypeid.errors %}
                      <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                  </div>
                  <div class="col-md-8">
                    {% for error in form.senotypename.errors %}
                      <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                  </div>
                </div>
            <!-- Senotype description -->
            <div class="row align-items-center mb-1">
                <div class="col md-12 d-flex align-items-center">
                    <label for="{{ form.senotypedescription.id }}" class="me-2 mb-0 label-wide label-left-margin"><strong>{{ form.senotypedescription.label.text }}</strong></label>
                    {{ form.senotypedescription(class="form-control", style="width: 100%;", rows="1") }}
                </div>
            </div>
            <!-- Senotype description errors -->
            <div class="row mb-1">
                <div class="col-md-12">
                    {% for error in form.senotypedescription.errors %}
                      <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                  </div>
            </div>
            <!-- DOI -->
            <div class="row mb-1 row-doi">
                  <div class="col-md-12">
                      {{ render_textarea_section(form, 'doi', 'doiSearchModal', '#FEF2F2', link_base_url='https://api.datacite.org/dois/', link_title='View DOI details', parse_code=False ) }}
                  </div>
                  <div class="col-md-4">
                    <!-- For alignment -->
                  </div>
                </div>
          </div> <!-- col-md-8 (Submission column) -->
    </div> <!-- row (Main row) -->
    <!-- Simple Assertions section-->
    <div class="row mt-3">
        <!-- TAXON section-->
        {{ render_fieldlist_section(form, "taxon", "taxonModal", col_class="col-md-2 input-cellBox") }}
        <!-- LOCATION section -->
        {{ render_fieldlist_section(form, "location", "locationModal", col_class="col-md-2 input-cellBox") }}
        <!-- CELL TYPE section -->
        {{ render_fieldlist_section(form, "celltype", "celltypeModal",  col_class="col-md-2 input-cellBox") }}
        <!-- HALLMARK section -->
        {{ render_fieldlist_section(form, "hallmark", "hallmarkModal",  col_class="col-md-3 input-cellBox input-cellBox--HM") }}
        <!-- OBSERVABLE section -->
        {{ render_fieldlist_section(form, "observable", "observableModal",  col_class="col-md-2 input-cellBox") }}
    </div>
    <div class="row mt-3">
        <!-- INDUCER section -->
        {{ render_fieldlist_section(form, "inducer", "inducerModal",  col_class="col-lg-2 col-6 input-cellBox") }}
        <!-- ASSAY section -->
        {{ render_fieldlist_section(form, "assay", "assayModal",  col_class="col-lg-3 col-6 input-cellBox") }}
        <!-- CONTEXT assertion section -->
        <div class="col-lg-6 input-cellBox input-cellBox--age ">
            <div class="row mb-3">
                    <h6><strong>Age</strong></h6>
                    <div class="col-6 col-lg-3 d-flex align-items-center mb-lg-0 mb-2">
                        <strong>{{ form.agevalue.label }}</strong>
                        {{ form.agevalue(class="form-control ms-2", type="number", maxlength="4", min="0", max="90", style="", disabled=True) }}
                    </div>
                    {% for error in form.agevalue.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                    <div class="col-6 col-lg-3 d-flex align-items-center mb-lg-0 mb-2">
                        <strong>{{ form.agelowerbound.label }}</strong>
                        {{ form.agelowerbound(class="form-control ms-2", type="number", maxlength="4", min="0", max="90",style="max-width:15ch;", disabled=True) }}
                    </div>
                    {% for error in form.agelowerbound.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                    <div class="col-6 col-lg-3 d-flex align-items-center">
                        <strong>{{ form.ageupperbound.label }}</strong>
                        {{ form.ageupperbound(class="form-control ms-2", type="number", maxlength="4",min="0", max="90", style="max-width:15ch;", disabled=True) }}
                    </div>
                    {% for error in form.ageupperbound.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                    <div class="col-6 col-lg-3 d-flex align-items-center">
                        <strong>{{ form.ageunit.label }}</strong>
                        {{ form.ageunit(class="form-control ms-2", maxlength="5", disabled=True) }}
                    </div>
                </div>
        </div>
    </div>
    <!-- PubMed citations/RRID origin/SenNet datasets -->
    <div class="row">
        <!-- CITATION section -->
        {{ render_fieldlist_section(form, "citation", "citationSearchModal", is_external=True,  col_class="col-md-4 input-cellBox", label_bg="#EBF6F9") }}
        <!-- ORIGIN section -->
        {{ render_fieldlist_section(form, "origin", "originSearchModal", is_external=True,  col_class="col-md-4 input-cellBox", label_bg="#EBF6F9") }}
        <!-- DATASET section -->
        {{ render_fieldlist_section(form, "dataset", "datasetSearchModal", is_external=True,  col_class="col-md-4 input-cellBox", label_bg="#EBF6F9") }}
    </div>
    <!-- Specified Markers/Regulating Markers -->
    <div class="accordion" id="markerAccordion">
      <div class="accordion-item">
        <h3 class="accordion-header" id="headingMarkers">
            <button
                    class="accordion-button w-100 text-center"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseMarkers"
                    aria-expanded="true"
                    aria-controls="collapseMarkers"
                    style="justify-content: center; font-size: 0.9em;"
                    id="btn-accordion">
                    Markers
            </button>
        </h3>
        <div id="collapseMarkers" class="accordion-collapse show" aria-labelledby="headingMarkers" data-bs-parent="#markerAccordion">
          <div class="accordion-body">
            <div class="row">
              {{ render_marker_section(form, "markerSearchModal", "markerCsvModal") }}
              {{ render_regmarker_section(form, "regmarkerSearchModal", "regmarkerCsvModal") }}
            </div>
          </div>
        </div>
      </div>
    </div>
</form>

<!-- MODAL DIVS -->
<!-- Valueset Select modals for simple assertions:
     taxon
     location
     celltype
     hallmark
     observable
     inducer
     assay-->
{{ valueset_modal("taxonModal", "Taxon", "taxon-modal-list") }}
{{ valueset_modal("locationModal", "Location", "location-modal-list") }}
{{ valueset_modal("celltypeModal", "Cell type", "celltype-modal-list") }}
{{ valueset_modal("hallmarkModal", "Hallmark", "hallmark-modal-list") }}
{{ valueset_modal("observableModal", "Observable", "observable-modal-list") }}
{{ valueset_modal("inducerModal", "Inducer", "inducer-modal-list") }}
{{ valueset_modal("assayModal", "Assay", "assay-modal-list") }}

<!-- Search modals for external API searches -->
<!-- Modal for external API search for PubMed citation-->
{{ search_modal(
    modal_id="citationSearchModal",
    modal_label="Search PubMed for Citation PMID",
    input_id="citation-search-input",
    explore_url="https://pubmed.ncbi.nlm.nih.gov/",
    explore_text="Explore PubMed",
    results_id="citation-search-results"
) }}
<!-- Modal for external API search for RRID origin-->
{{ search_modal(
    modal_id="originSearchModal",
    modal_label="Search SciCrunch for Origin RRID",
    input_id="origin-search-input",
    explore_url="https://scicrunch.org/resolver/",
    explore_text="Explore SciCrunch",
    results_id="origin-search-results"
) }}
<!-- Modal for external SenNet entity-api search for SenNet dataset-->
{{ search_modal(
    modal_id="datasetSearchModal",
    modal_label="Search SenNet Data Portal for dataset ID",
    input_id="dataset-search-input",
    explore_url="https://data.sennetconsortium.org",
    explore_text="Explore SenNet Data Portal",
    results_id="dataset-search-results"
) }}
<!-- Modal for external DataCite API search for DOI -->
{{ search_modal(
    modal_id="doiSearchModal",
    modal_label="Search DataCite for DOI",
    input_id="doi-search-input",
    explore_url="https://commons.datacite.org/",
    explore_text="Explore DataCite Commons",
    results_id="doi-search-results"
) }}
<!-- Modal for external ubkg-api search for adding single specified marker-->
<div class="modal fade" id="markerSearchModal" tabindex="-1" aria-labelledby="markerSearchModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="markerSearchModalLabel">Search UBKG for marker</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Radio buttons for marker type -->
                <div class="mb-3">
                    <label class="form-label">Marker type:</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="marker-type" id="marker-type-gene" value="gene" checked>
                            <label class="form-check-label" for="marker-type-gene">Gene</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="marker-type" id="marker-type-protein" value="protein">
                            <label class="form-check-label" for="marker-type-protein">Protein</label>
                        </div>
                    </div>
                </div>
                <input type="text" id="marker-search-input" class="form-control" placeholder="Enter query...">
                <div id="marker-search-results" class="mt-3">
                    <!-- Search results from API appear here -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal for external ubkg-api search for adding single regulated marker-->
<div class="modal fade" id="regmarkerSearchModal" tabindex="-1" aria-labelledby="regmarkerSearchModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="regmarkerSearchModalLabel">Search UBKG for marker</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Radio buttons for marker type -->
                <div class="mb-3">
                    <label class="form-label">Marker type:</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="marker-type" id="regmarker-type-gene" value="gene" checked>
                            <label class="form-check-label" for="regmarker-type-gene">Gene</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="marker-type" id="regmarker-type-protein" value="protein">
                            <label class="form-check-label" for="regmarker-type-protein">Protein</label>
                        </div>
                    </div>
                </div>
                <!-- Radio buttons for marker action -->
                <div class="mb-3">
                    <label class="form-label">Action:</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="regmarker-action" id="regmarker-action-up" value="up_regulates" checked>
                            <label class="form-check-label" for="regmarker-action-up">up</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="regmarker-action" id="regmarker-action-down" value="down_regulates">
                            <label class="form-check-label" for="regmarker-action-down">down</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="regmarker-action" id="regmarker-action-inc" value="inconclusively_regulates">
                            <label class="form-check-label" for="regmarker-action-inc">inconclusively</label>
                        </div>
                    </div>
                </div>
                <input type="text" id="regmarker-search-input" class="form-control" placeholder="Enter query...">
                <div id="regmarker-search-results" class="mt-3">
                    <!-- Search results from API appear here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- UPDATE FORM below edit_form -->
<form id="update_form" method="post" action="/update" class="my-4">
  <div class="d-flex flex-row-reverse container-fluid">
    <div class="mx-2">
      <!-- Update Button -->
      <button id="update_btn" type="submit" class="btn btn-primary rounded-0" disabled>
        Update
      </button>
      <!-- Spinner (Bootstrap) -->
      <div id="update-spinner"
           class="spinner-border text-primary"
           role="status"
           style="display:none; margin-left: 10px; width:2rem; height:2rem; z-index:10;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <!-- Spinner Label -->
      <div id="update-spinner-label"
           style="display:none; margin-left: 10px; white-space:nowrap;">
        Updating...
      </div>
    </div>
  </div>
</form>

<!-- CSV UPLOAD CSV MODAL FORMS -->
<!-- Modal divs with form to upload bulk load of markers via CSV. Placed outside of edit form so that the divs will not
display with transparent background--apparently, a known bug in this scenario. -->
<!-- Specified Markers -->
<div class="modal fade" id="markerCsvModal" tabindex="-1" aria-labelledby="markerCsvModalLabel">
    <div class="modal-dialog">
        <form id="marker-csv-form" class="modal-content" enctype="multipart/form-data">
            <div class="modal-header">
                <h5 class="modal-title" id="markerCsvModalLabel">Upload Marker CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Please upload a CSV file with <strong>type</strong> and <strong>id</strong> columns.
                    <ul>
                        <li>
                            <small>
                                <strong>type</strong> must be <code>gene</code> or <code>protein</code>.
                            </small>
                        </li>
                        <li>
                            <small>
                                A gene <strong>id</strong> must correspond to a HGNC symbol--e.g., <code>BRCA1</code>.
                            </small>
                        </li>
                        <li>
                            <small>
                                A protein <strong>id</strong> must correspond to a UniProtKB ID--e.g., <code>Q13201</code>.
                            </small>
                        </li>
                    </ul>
                    <input type="file" class="form-control mb-2" id="marker-csv-file" accept=".csv" required>
                    <div id="csv-validation-results" class="mt-2 small">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="submit" id="marker-csv-submit" class="btn btn-primary" disabled>Add specified markers</button>
            </div>
        </form>
    </div>
</div>
<!-- Regulating markers-->
<div class="modal fade" id="regmarkerCsvModal" tabindex="-1" aria-labelledby="regmarkerCsvModalLabel">
    <div class="modal-dialog">
        <form id="regmarker-csv-form" class="modal-content" enctype="multipart/form-data">
            <div class="modal-header">
                <h5 class="modal-title" id="regmarkerCsvModalLabel">Upload Marker CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Please upload a CSV file with <strong>type</strong>, <strong>id</strong>, and <strong>action</strong> columns.
                    <br>
                    <ul>
                        <li>
                            <small>
                                <strong>type</strong> must be <code>gene</code> or <code>protein</code>.
                            </small>
                        </li>
                        <li>
                            <small>
                                A gene <strong>id</strong> must correspond to a HGNC symbol--e.g., <code>BRCA1</code>.
                            </small>
                        </li>
                        <li>
                            <small>
                                A protein <strong>id</strong> must correspond to a UniProtKB ID--e.g., <code>Q13201</code>.
                            </small>
                        </li>
                        <li>
                            <small>
                                The <strong>action</strong> must be one of the following:
                            </small>
                            <ul>
                                <li>
                                    <small>
                                        <code>1</code> for <i>upregulation</i>
                                    </small>
                                </li>
                                <li>
                                    <small>
                                        <code>-1</code> for <i>downregulation</i>
                                    </small>
                                </li>
                                <li>
                                    <small>
                                        <code>0</code> for <i>inconclusive regulation</i>
                                    </small>
                                </li>
                            </ul>
                        </li>
                    </ul>
                     <br>
                    <br>
                     <input type="file" class="form-control mb-2" id="regmarker-csv-file" accept=".csv" required>
                    <div id="regcsv-validation-results" class="mt-2 small">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="submit" id="regmarker-csv-submit" class="btn btn-primary" disabled>Add regulating markers</button>
            </div>
        </form>
    </div>
</div>

<!-- JAVASCRIPTS-->

<!-- Get the id of the node selected in the treeview for the senotype-treeview.js script. -->
<script>
  window.selected_node_id = document.getElementById('selected_node_id')
    ? document.getElementById('selected_node_id').value
    : null;
</script>

<!-- Includes -->
<script src="{{ url_for('static', filename='spinner.js') }}"></script>
<!-- Script to manage the Senotype treeview-->
<script src="{{ url_for('static', filename='senotype-treeview.js') }}"></script>
<!-- Script to enable/disable controls based on whether the selected id is editable -->
<script src="{{ url_for('static', filename='enable-based-on-selection.js') }}"></script>
<!-- Script behind the update button-->
<script src="{{ url_for('static', filename='update-button.js') }}"></script>
<!-- Script to add external link buttons to inputs -->
<script src="{{ url_for('static', filename='add-link-buttons.js') }}"></script>
<!-- Respond to changes in input: enable/disable update button; turn off display of previous errors. -->
<script src="{{ url_for('static', filename='input-changes.js') }}"></script>
<!-- Scripts to manage modals related to the add and remove buttons-->
<script src="{{ url_for('static', filename='valueset-modal.js') }}"></script>
<script src="{{ url_for('static', filename='external-list-modal.js') }}"></script>
<script src="{{ url_for('static', filename='marker-modal.js') }}"></script>
<script src="{{ url_for('static', filename='marker-csv.js') }}"></script>
<script src="{{ url_for('static', filename='regmarker-modal.js') }}"></script>
<script src="{{ url_for('static', filename='regmarker-csv.js') }}"></script>
<script src="{{ url_for('static', filename='doi-modal.js') }}"></script>

{% endblock %}
